## API Management

| ControlId | Dependent Azure API(s) and Properties | Control spec-let |
|-----------|-------------------------------------|------------------|
| <b>ControlId:</b><br>Azure_APIManagement_AuthN_Disable_Management_API<br><b>DisplayName:</b><br>Do not use API Management REST API. <br><b>Description: </b><br> Do not use API Management REST API. | <b>ARM API to list APIMs and its related property at Subscription level: </b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.ApiManagement/service?</br>api-version=2019-12-01</br><b>Properties:</b></br>sku <br><br> <b>ARM API to get tenant access information details without secrets:</b><br> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/tenant/access?<br> api-version=2019-12-01<br><b>Properties:</b><br>enabled| <b>Passed: </b><br>'Enable Management REST API' option is turned OFF.<br><b>Failed: </b><br>'Enable Management REST API' option is turned ON.<br><b>Verify: </b><br> Management API setting could not be verified as the API Management service is connected to a Virtual Network. As a result, control plane traffic on port 3443 is denied. <br><b>NotApplicable: </b><br> This control does not apply to consumption tier.|
| <b>ControlId:</b><br>Azure_APIManagement_AuthN_Use_AAD_for_Client_AuthN<br><b>DisplayName:</b><br>Enterprise applications using APIM must authenticate developers/applications using Azure Active Directory backed credentials.<br><b>Description: </b><br> Enterprise applications using APIM must authenticate developers/applications using Azure Active Directory backed credentials. | <b> ARM API to list APIMs and its related property at Subscription level: </b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.ApiManagement/service?<br>api-version=2019-12-01<br><b>Properties:</b><br>sku <br><br><b>ARM API to list collection of portalsettings defined within a service instance: <br> </b> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/portalsettings?<br>api-version=2018-06-01-preview <br><b>Properties:</b><br> name: "signup" <br> properties/enabled <br><br> <b>ARM API to list collection of Identity Provider configured in the specified service instance:</b> <br> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/identityProviders?<br>api-version=2019-12-01 <br><b>Properties:</b><br>properties/type | <b>Passed: </b><br> 1. AAD Identity provider is being used for authentication in developer portal. <br> 2. Sign-up/sign-in option has been entirely disabled. <br><br><b>Failed: </b><br>Identity provider other than AAD is being used for authentication in developer portal.<br><br><b>Verify: </b><br> Sign up option setting could not be verified as the API Management service is connected to a Virtual Network. As a result, control plane traffic on port 3443 is denied. <br><br><b>NotApplicable: </b><br> This control does not apply to consumption tier.|
| <b>ControlId:</b><br>Azure_APIManagement_DP_Use_Secure_TLS_Version<br><b>DisplayName:</b><br>Ensure that only the most secure and up to date version of TLS is enabled on the API gateway.<br><b>Description: </b><br> Ensure that only the most secure and up to date version of TLS is enabled on the API gateway. | <b>ARM API to list APIMs and its related property at Subscription level: </b> </br> /subscriptions/{subscriptionId}/providers/Microsoft.ApiManagement/service?<br>api-version=2019-12-01 <br><b>Properties:</b><br> properties/customProperties <br> <b> Custom properties of the API Management service: </b> <br> 1. Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Ciphers.TripleDes168 <br> 2. Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Protocols.Tls10 <br>3. Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Protocols.Tls11 <br>4. Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Protocols.Ssl30 <br>5. Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Backend.Protocols.Tls10 <br>6. Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Backend.Protocols.Tls11 <br>7. Microsoft.WindowsAzure.ApiManagement.Gateway.Security.Backend.Protocols.Ssl30 | <b>Passed: </b><br>All old versions of protocols and ciphers configurations are disabled.<br><b>Failed: </b><br>Old versions of protocols and ciphers configurations are being used.|
| <b>ControlId:</b><br>Azure_APIManagement_AuthN_Secure_API_Using_Client_Certificates<br><b>DisplayName:</b><br>Use client certificates for authentication between gateway and backend APIs.<br><b>Description: </b><br>Use client certificates for authentication between gateway and backend APIs. | <b>ARM API to list APIMs and its related property at Subscription level: </b> </br> /subscriptions/{subscriptionId}/providers/Microsoft.ApiManagement/service?<br>api-version=2019-12-01 <br><b>Properties:</b><br>sku<br><br><b>ARM API to list all APIs of the API Management service instance:</b><br>/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/apis?<br>api-version=2019-01-01 <br><b>Properties:</b><br>id <br><br><b> ARM API to get policy configuration at the API level:</b><br>/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/apis/{apiId}/policies?<br>api-version=2019-01-01 <br><b>Properties:</b> <br> properties.value | <b>Passed: </b><br>Gateway authentication using client certificate is enabled in API(s), OR <br> No API(s) found to enable Gateway authentication using client certificate. <br><b>Failed: </b><br>Gateway authentication using client certificate is not enabled in API(s).|
| <b>ControlId:</b><br>Azure_APIManagement_AuthN_Use_Managed_Service_Identity<br><b>DisplayName:</b><br>Use Managed Service Identity (MSI) for accessing other AAD-protected resources from the API management instance.<br><b>Description: </b><br>Use Managed Service Identity (MSI) for accessing other AAD-protected resources from the API management instance. | <b>ARM API to list APIMs and its related property at Subscription level: </b> </br> /subscriptions/{subscriptionId}/providers/Microsoft.ApiManagement/service?<br>api-version=2019-12-01 <br><b>Properties:</b><br>sku<br>identity.type| <b>Passed: </b><br>APIM instance is using Managed Service Identity(MSI).<br><b>Failed: </b><br>APIM instance is not using Managed Service Identity(MSI).|
| <b>ControlId:</b><br>Azure_APIManagement_AuthN_Verify_Delegated_Authentication<br><b>DisplayName:</b><br>Delegated authentication should be implemented securely.<br><b>Description: </b><br>If delegated authentication is enabled, ensure that it is implemented securely. | <b>ARM API to list APIMs and its related property at Subscription level: </b> </br> /subscriptions/{subscriptionId}/providers/Microsoft.ApiManagement/service?<br>api-version=2019-12-01 <br><b>Properties:</b><br>sku<br><br><b>ARM API to list a collection of portalsettings defined within a service instance: </b><br> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/portalsettings?<br>api-version=2018-06-01-preview <br> <b>Properties</b><br>properties.subscriptions.enabled<br> properties.userRegistration.enabled| <b>Passed: </b><br>APIM instance is not using Delegated authentication.<br><b>Failed: </b><br> APIM instance is using Delegated authentication, OR<br>Provisioning state is not equal to succeeded.</br><b>Verify:</b> <br>Unable to verify the delegation setting since management endpoint 3443 is disabled. <br><b>Not Applicable:</b> <br>This control does not apply to consumption tier APIM.|
| <b>ControlId:</b><br>Azure_APIManagement_AuthZ_Enable_Requires_Subscription<br><b>DisplayName:</b><br>'Requires Subscription' option must be turned on for all products in an API Management instance.<br><b>Description: </b><br>'Requires Subscription' option must be turned on for all products in an API Management instance. | <b>ARM API to list a collection of products in the specified service instance:</b> </br> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/products?<br>api-version=2019-01-01 <br><b>Properties:</b><br> properties.subscriptionRequired<br> properties.state| <b>Passed: </b><br>'Requires Subscription' option is turned 'ON' for all product(s) with published state in APIM instance, OR<br>No product(s) found in APIM instance, OR<br>No product(s) found with 'Published' state.<br><b>Failed: </b><br>'Requires Subscription' option is turned 'OFF' for product(s) in APIM instance.|
| <b>ControlId:</b><br>Azure_APIManagement_AuthZ_Enable_User_Authorization_For_API<br><b>DisplayName:</b><br>Ensure that either OAuth 2.0 or OpenID Connect are used to authorize developer accounts in API Management.<br><b>Description: </b><br>Ensure that either OAuth 2.0 or OpenID Connect are used to authorize developer accounts in API Management.| <b>ARM API to list APIMs and its related property at Subscription level: </b> </br> /subscriptions/{subscriptionId}/providers/Microsoft.ApiManagement/service?<br> api-version=2019-12-01 <br><b>Properties:</b><br>sku<br><br><b>ARM API to list all APIs of the API Management service instance:</b><br>/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/apis?<br>api-version=2019-01-01 <br><b>Properties:</b><br>id <br><br><b> ARM API to get the details of the API specified by its identifier:</b><br>/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/apis/{apiId}?<br>api-version=2019-01-01<br><b>Properties:</b> <br> properties.authenticationSettings.oAuth2 <br> properties.authenticationSettings.openid | <b>Passed: </b><br>Either OAuth 2.0 or OpenID Connect are used to authorize developer accounts for this APIM instance.<br><b>Failed: </b><br>Neither OAuth 2.0 nor OpenID Connect are used to authorize developer accounts for this APIM instance.|
| <b>ControlId:</b><br>Azure_APIManagement_AuthZ_Validate_JWT<br><b>DisplayName:</b><br>Ensure that JWT validation is enabled if using OAuth 2.0 or OpenID connect.<br><b>Description: </b><br>Ensure that JWT validation is enabled if using OAuth 2.0 or OpenID connect. | <b>ARM API to list APIMs and its related property at Subscription level: </b> </br> /subscriptions/{subscriptionId}/providers/Microsoft.ApiManagement/service?<br>api-version=2019-12-01 <br><b>Properties:</b><br>sku<br><br> <b>ARM API to list all APIs of the API Management service instance:</b><br>/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/apis?<br>api-version=2019-01-01 <br><b>Properties:</b><br>id <br><br><b> ARM API to get the details of the API specified by its identifier:</b><br>/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/apis/{apiId}?<br>api-version=2019-01-01<br><b>Properties:</b><br> properties.authenticationSettings.oAuth2 <br> properties.authenticationSettings.openid<br><br><b> ARM API to get policy configuration at the API level:</b><br>/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/apis/{apiId}/policies?<br>api-version=2019-01-01 <br><b>Properties:</b> <br> properties.value| <b>Passed: </b><br>JWT Token validation found for OAuth/OpenID connect authorization, OR <br> No API(s) found in APIM Management instance.<br><b>Failed: </b><br>JWT Token validation not found for OAuth/OpenID connect authorization.|
| <b>ControlId:</b><br>Azure_APIManagement_DP_Remove_Default_Products	<br><b>DisplayName:</b><br>Delete the two sample products 'Starter' and 'Unlimited' to avoid accidental exposure of APIs.<br><b>Description: </b><br> Delete the two sample products 'Starter' and 'Unlimited' to avoid accidental exposure of APIs.|<b>ARM API to list a collection of products in the specified service instance:</b> </br> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/products?<br>api-version=2019-01-01 <br><b>Properties:</b><br>name <br>| <b>Passed: </b><br>APIM does not contains sample products: Starter and Unlimited.<br><b>Failed: </b><br>APIM contains sample products: Starter and Unlimited.|
| <b>ControlId:</b><br>Azure_APIManagement_DP_Use_HTTPS_URL_Scheme<br><b>DisplayName:</b><br>Ensure Backend API(s) are only accessible over HTTPS via API Management service.<br><b>Description: </b><br>Ensure Backend API(s) are only accessible over HTTPS via API Management service. | <b>ARM API to list APIMs and its related property at Subscription level: </b> </br> /subscriptions/{subscriptionId}/providers/Microsoft.ApiManagement/service?<br>api-version=2019-12-01 <br><b>Properties:</b><br>id<br><br><b>ARM API to list all APIs of the API Management service instance:</b><br>/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/apis?<br>api-version=2019-01-01 <br><b>Properties:</b><br>properties.protocols <br>| <b>Passed: </b><br>All API(s) are configured to use secure HTTP access to the backend via API Management, OR <br> No API(s) found in APIM instance.<br><b>Failed: </b><br>Found API(s) that are configured to use non-secure HTTP access to the backend via API Management.<br> <b>Verify</b> <br>Unable to verify the delegation setting since management endpoint 3443 is disabled.|
| <b>ControlId:</b><br>Azure_APIManagement_Audit_Enable_Diagnostics_Log<br><b>DisplayName:</b><br>Diagnostics logs must be enabled for API Management service.<br><b>Description: </b><br>Diagnostics logs must be enabled for API Management service. | <b>ARM API to list diagnostic setting details of API Management resources: </b> </br> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}<br>/providers/Microsoft.ApiManagement/service/{serviceName}/providers<br>/microsoft.insights/diagnosticSettings?api-version=2017-05-01-preview <br><b>Properties:</b><br> name <br>properties.logs.category <br> properties.logs.enabled <br> properties.logs.retentionPolicy.enabled <br> properties.logs.retentionPolicy.days <br> properties.workspaceId <br> properties.storageAccountId <br> properties.eventHubName <br>|<b>Scope: </b> All API Management resources in subscription.<br><br> <b>Config: </b><br> DiagnosticLogs: GatewayLogs, WebSocketConnectionLogs <br> DiagnosticMinRetentionPeriod : 365  <br> DiagnosticForeverRetentionValue : 0 <br><br> <b>Passed: </b><br>1. Required diagnostic logs are enabled.<br> *and* <br> 2. At least one of the below setting configured:<br> a. Log Analytics. <br> b. Storage account (with min Retention period of 365 or forever(Retention period 0). <br> c. Event Hub. <br><b>Failed: </b><br>1. Diagnostics setting is disabled for resource. <br> *or* <br> 2. Diagnostic setting meet the following conditions: <br> a. All diagnostic logs are not enabled. <br> b. None of the below setting is configured: <br> i. Log Analytics.<br> ii. Storage account (with min Retention period of 365 or forever(Retention period 0).<br> iii. Event Hub. <br> <b>Error</b> <br>Required logs are not configured in control settings.|

	






