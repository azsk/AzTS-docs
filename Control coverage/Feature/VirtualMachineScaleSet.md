| ControlId | Dependent Azure API(s) and Properties | Control Spec |
|-----------|-------------------------------------|------------------|
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_Audit_Enable_Diagnostics<br><br><b>DisplayName:</b><br>Diagnostics (IaaSDiagnostics extension on Windows; LinuxDiagnostic extension on Linux) must be enabled on Virtual Machine Scale Set.<br><br><b>Description: </b><br> Diagnostics (IaaSDiagnostics extension on Windows; LinuxDiagnostic extension on Linux) must be enabled on Virtual Machine Scale Set. |<b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br> properties/storageProfile/osDisk/osType<br>properties/virtualMachineProfile/extensionProfile/extensions| <b>Scope: </b> All VMSS in a subscription<br><br><b>Config: </b><br> LinuxExtensionType:"LinuxDiagnostic"<br>LinuxExtensionPublisher:"Microsoft.OSTCExtensions"<br>WindowsExtensionType:"IaaSDiagnostics"<br>WindowsExtensionPublisher:"Microsoft.Azure.Diagnostics"<br><br><b>Passed: </b><br>Required diagnostics extension is present in VM Scale Set.<br><br><b>Failed: </b><br>Required diagnostics extension is missing in VM Scale Set. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_Config_Enable_NSG<br><br><b>DisplayName:</b><br>NSG must be configured for Virtual Machine Scale Set.<br><br><b>Description: </b><br> NSG must be configured for Virtual Machine Scale Set. |<b> ARM API to get all the public IPs for the specified VMSS: </b> <br> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers<br>/Microsoft.Compute/virtualMachineScaleSets/{resourceName}/publicipaddresses<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br> properties/ipAddress <br><br><b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br> properties/virtualMachineProfile/networkProfile/networkInterfaceConfigurations/properties/networkSecurityGroup<br>properties/virtualMachineProfile/networkProfile/networkInterfaceConfigurations/properties/ipConfigurations/properties/subnet| <b>Scope: </b> All VMSS in a subscription<br><br><b>Config: </b>NA<br><br><b>Passed: </b><br>VMSS does not have any associated public IP<br>or NSG is configured for the VMSS.<br><br><b>Failed: </b><br>VMSS have associated public IP and no NSG<br> is configured for it. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_Deploy_Monitoring_Agent<br><br><b>DisplayName:</b><br>Log analytics agent should be installed on Virtual Machine Scale Set.<br><br><b>Description: </b><br> Log analytics agent should be installed on Virtual Machine Scale Set. |<b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br> properties/storageProfile/osDisk/osType<br>properties/virtualMachineProfile/extensionProfile/extensions| <b>Scope: </b> All VMSS in a subscription<br><br><b>Config: </b><br> LinuxExtensionType:"OmsAgentForLinux"<br>LinuxExtensionPublisher:"Microsoft.EnterpriseCloud.Monitoring"<br>WindowsExtensionType:"MicrosoftMonitoringAgent"<br>WindowsExtensionPublisher:"Microsoft.EnterpriseCloud.Monitoring"<br><br><b>Passed: </b><br>Required monitoring agent is present in VM Scale Set.<br><br><b>Failed: </b><br>Required monitoring agent is missing in VM Scale Set. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_NetSec_Dont_Open_Management_Ports<br><br><b>DisplayName:</b><br>Management ports must not be open on Virtual Machine Scale Sets.<br><br><b>Description: </b><br> Do not leave management ports open on Virtual Machine Scale Set. |<b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br>properties/storageProfile/osDisk/osType<br>properties/virtualMachineProfile/networkProfile/networkInterfaceConfigurations/properties/networkSecurityGroup<br>properties/virtualMachineProfile/networkProfile/networkInterfaceConfigurations/properties/ipConfigurations/properties/subnet<br><br><b> ARM API to list all the NSG configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkSecurityGroups<br>?api-version=2019-04-01 <br><br><b>Properties:</b><br> properties/securityRules/properties/destinationPortRange| <b>Scope: </b> All VMSS in a subscription<br><br><b>Config: </b><br>RestrictedPortsForWindows:"445,3389,5985"<br>RestrictedPortsForLinux:"445,3389,22"<br><br><b>Passed: </b><br>No inbound port is open in attached NSG<br>or No restricted port is open in attached NSG.<br><br><b>Failed: </b><br>No NSG found on the VMSS <br>or One or more restricted ports are open in NSG. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_NetSec_Justify_PublicIPs<br><br><b>DisplayName:</b><br>Public IPs on a Virtual Machine Scale Set instances should be carefully reviewed.<br><br><b>Description: </b><br> Public IPs on a Virtual Machine Scale Set instances should be carefully reviewed. |<b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br>properties/virtualMachineProfile/networkProfile/networkInterfaceConfigurations/properties/ipConfigurations/properties/subnet<br><br><b> ARM API to get all the public IPs for the specified VMSS: </b> <br> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers<br>/Microsoft.Compute/virtualMachineScaleSets/{resourceName}/publicipaddresses<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br> properties/ipAddress| <b>Scope: </b> All VMSS in a subscription<br><br><b>Config: </b>NA<br><br><b>Passed: </b><br>No Public IP is associated with VMSS<br>or VMSS has Public IP is associated with it<br> but its not part of ExpressRoute connected virtual network.<br><br><b>Failed: </b><br>VMSS is part of an ExpressRoute connected virtual network<br> and has Public IP associated with it. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_SI_Enable_Antimalware<br><br><b>DisplayName:</b><br>Antimalware must be enabled with real time protection on Virtual Machine Scale Set.<br><br><b>Description: </b><br> Antimalware must be enabled with real time protection on Virtual Machine Scale Set. |<b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br>properties/storageProfile/osDisk/osType<br>properties/virtualMachineProfile/extensionProfile/extension<br><br><b> ARM API to get all the VM instances for the specified VMSS: </b> <br> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers<br>/Microsoft.Compute/virtualMachineScaleSets/{resourceName}/virtualMachines<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br> instance/resources(Microsoft.Compute/virtualMachines/extensions)| <b>Scope: </b> All Windows VMSS in a subscription<br><br><b>Config: </b><br>ExtensionType:"IaaSAntimalware"<br>Publisher:"Microsoft.Azure.Security"<br><br><b>Passed: </b><br>Antimalware Malware extension is deployed at VMSS model<br> and all it's VM instances with Auto Upgrade<br> to minor version enabled and Realtime protection enabled.<br><br><b>Failed: </b><br>AntiMalware extension not deplyed at VMSS model<br> or at one or more VM instances<br> or AntiMalware extension is present but<br> Auto Upgarde to minor version is disabled <br>or AntiMalware extension is present but<br> Auto Realtime protection is disabled. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_SI_Enable_Auto_OS_Upgrade<br><br><b>DisplayName:</b><br>Enable automatic OS image upgrade on Virtual Machine Scale Set.<br><br><b>Description: </b><br> Enable automatic OS image upgrade on Virtual Machine Scale Set. |<b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br>properties/upgradePolicy/automaticOSUpgradePolicy/enableAutomaticOSUpgrade| <b>Scope: </b> All VMSS in a subscription<br><br><b>Config: </b>NA<br><br><b>Passed: </b><br>Automatic OS image upgrade is configured for VM Scale Set.<br><br><b>Failed: </b><br>Automatic OS image upgrade is not configured for VM Scale Set. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_SI_Latest_Model_Applied<br><br><b>DisplayName:</b><br>All VMs in VM Scale Set must be up-to-date with the latest scale set model.<br><br><b>Description: </b><br> All VMs in VM Scale Set must be up-to-date with the latest scale set model. |<b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br>properties/upgradePolicy/mode<br><br><b> ARM API to get all the VM instances for the specified VMSS: </b> <br> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers<br>/Microsoft.Compute/virtualMachineScaleSets/{resourceName}/virtualMachines<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br> instance/properties/latestModelApplied| <b>Scope: </b> All VMSS in a subscription<br><br><b>Config: </b>NA<br><br><b>Passed: </b><br>VMSS upgrade policy is not manual <br>or VMSS upgrade policy is manual but all the VM <br>instances are running on latest VM Scale Set model.<br><br><b>Failed: </b><br>VMSS upgrade policy is manual and any of the VM <br>instance is not running on latest VM Scale Set model. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_SI_Missing_OS_Patches<br><br><b>DisplayName:</b><br>System updates on virtual machine scale sets must be installed.<br><br><b>Description: </b><br> Virtual Machine Scale Set must have all the required OS patches installed. |<b> ARM API to fetch all the security assessment for the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/assessments<br>?api-version=2020-01-01 <br><br><b>AssessmentName:</b><br>bd20bd91-aaf1-7f14-b6e4-866de2f43146| <b>Scope: </b> All VMSS in a subscription<br><br><b>Config: </b>NA<br><br><b>Passed: </b><br>ASC assessment is in healthy state.<br><br><b>Failed: </b><br>ASC assessment is in unhealthy state. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_SI_Remediate_Security_Vulnerabilities<br><br><b>DisplayName:</b><br>Vulnerabilities in security configuration on your virtual machine scale sets must be remediated.<br><br><b>Description: </b><br> Vulnerabilities in security configuration on your virtual machine scale sets must be remediated. |<b> ARM API to fetch all the security assessment for the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/assessments<br>?api-version=2020-01-01 <br><br><b>AssessmentName:</b><br>8941d121-f740-35f6-952c-6561d2b38d36| <b>Scope: </b> All VMSS in a subscription<br><br><b>Config: </b>NA<br><br><b>Passed: </b><br>ASC assessment is in healthy state.<br><br><b>Failed: </b><br>ASC assessment is in unhealthy state. |
