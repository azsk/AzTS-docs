## VirtualMachineScaleSet

| ControlId | Dependent Azure API(s) and Properties | Control spec-let |
|-----------|-------------------------------------|------------------|
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_Audit_Enable_Diagnostics<br><br><b>DisplayName:</b><br>Diagnostics (IaaSDiagnostics extension on Windows; LinuxDiagnostic extension on Linux) must be enabled on Virtual Machine Scale Set.<br><br><b>Description: </b><br> Diagnostics (IaaSDiagnostics extension on Windows; LinuxDiagnostic extension on Linux) must be enabled on Virtual Machine Scale Set. |<b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br> properties/storageProfile/osDisk/osType<br>properties/virtualMachineProfile/extensionProfile/extensions|<b>Passed: </b><br>Required diagnostics extension is present in VM Scale Set.<br><br><b>Failed: </b><br>Required diagnostics extension is missing in VM Scale Set. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_Config_Enable_NSG<br><br><b>DisplayName:</b><br>NSG must be configured for Virtual Machine Scale Set.<br><br><b>Description: </b><br> NSG must be configured for Virtual Machine Scale Set. |<b> ARM API to get all the public IPs for the specified VMSS: </b> <br> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers<br>/Microsoft.Compute/virtualMachineScaleSets/{resourceName}/publicipaddresses<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br> properties/ipAddress <br><br><b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br> properties/virtualMachineProfile/networkProfile/networkInterfaceConfigurations/properties/networkSecurityGroup<br>properties/virtualMachineProfile/networkProfile/networkInterfaceConfigurations/properties/ipConfigurations/properties/subnet| <b>Passed: </b><br>VMSS does not have any associated public IP<br>or NSG is configured for the VMSS.<br><br><b>Failed: </b><br>VMSS have associated public IP and no NSG<br> is configured for it. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_Deploy_Monitoring_Agent<br><br><b>DisplayName:</b><br>Log analytics agent should be installed on Virtual Machine Scale Set.<br><br><b>Description: </b><br> Log analytics agent should be installed on Virtual Machine Scale Set. |<b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br> properties/storageProfile/osDisk/osType<br>properties/virtualMachineProfile/extensionProfile/extensions| <b>Passed: </b><br>Required monitoring agent is present in VM Scale Set.<br><br><b>Failed: </b><br>Required monitoring agent is missing in VM Scale Set. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_NetSec_Dont_Open_Management_Ports<br><br><b>DisplayName:</b><br>Management ports must not be open on Virtual Machine Scale Sets.<br><br><b>Description: </b><br> Do not leave management ports open on Virtual Machine Scale Set. |<b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br>properties/storageProfile/osDisk/osType<br>properties/virtualMachineProfile/networkProfile/networkInterfaceConfigurations/properties/networkSecurityGroup<br>properties/virtualMachineProfile/networkProfile/networkInterfaceConfigurations/properties/ipConfigurations/properties/subnet<br><br><b> ARM API to list all the NSG configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkSecurityGroups<br>?api-version=2019-04-01 <br><br><b>Properties:</b><br> properties/securityRules/properties/destinationPortRange| <b>Passed: </b><br>No inbound port is open in attached NSG<br>or No restricted port is open in attached NSG.<br><br><b>Failed: </b><br>No NSG found on the VMSS <br>or One or more restricted ports are open in NSG. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_NetSec_Justify_PublicIPs<br><br><b>DisplayName:</b><br>Public IPs on a Virtual Machine Scale Set instances should be carefully reviewed.<br><br><b>Description: </b><br> Public IPs on a Virtual Machine Scale Set instances should be carefully reviewed. |<b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br>properties/virtualMachineProfile/networkProfile/networkInterfaceConfigurations/properties/ipConfigurations/properties/subnet<br><br><b> ARM API to get all the public IPs for the specified VMSS: </b> <br> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers<br>/Microsoft.Compute/virtualMachineScaleSets/{resourceName}/publicipaddresses<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br> properties/ipAddress| <b>Passed: </b><br>No Public IP is associated with VMSS<br>or VMSS has Public IP is associated with it<br> but its not part of ExpressRoute connected virtual network.<br><br><b>Failed: </b><br>VMSS is part of an ExpressRoute connected virtual network<br> and has Public IP associated with it. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_SI_Enable_Antimalware<br><br><b>DisplayName:</b><br>Antimalware must be enabled with real time protection on Virtual Machine Scale Set.<br><br><b>Description: </b><br> Antimalware must be enabled with real time protection on Virtual Machine Scale Set. |<b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br>properties/storageProfile/osDisk/osType<br>properties/virtualMachineProfile/extensionProfile/extension<br><br><b> ARM API to get all the VM instances for the specified VMSS: </b> <br> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers<br>/Microsoft.Compute/virtualMachineScaleSets/{resourceName}/virtualMachines<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br> instance/resources(Microsoft.Compute/virtualMachines/extensions)| <b>Passed: </b><br>Antimalware Malware extension is deployed at VMSS model<br> and all it's VM instances with Auto Upgrade<br> to minor version enabled and Realtime protection enabled.<br><br><b>Failed: </b><br>AntiMalware extension is not deployed at VMSS model<br> or at one or more VM instances<br> or AntiMalware extension is present but<br> Auto Upgrade to minor version is disabled <br>or AntiMalware extension is present but<br> Auto Realtime protection is disabled.<br><br><b>Error: </b><br>Required Extension details is not properly<br> defined in control settings.<br><br><b>NotApplicable: </b><br>VMSS is running on Linux OS. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_SI_Enable_Auto_OS_Upgrade<br><br><b>DisplayName:</b><br>Enable automatic OS image upgrade on Virtual Machine Scale Set.<br><br><b>Description: </b><br> Enable automatic OS image upgrade on Virtual Machine Scale Set. |<b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br>properties/upgradePolicy/automaticOSUpgradePolicy/enableAutomaticOSUpgrade| <b>Passed: </b><br>Automatic OS image upgrade is configured for VM Scale Set.<br><br><b>Failed: </b><br>Automatic OS image upgrade is not configured for VM Scale Set. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_SI_Latest_Model_Applied<br><br><b>DisplayName:</b><br>All VMs in VM Scale Set must be up-to-date with the latest scale set model.<br><br><b>Description: </b><br> All VMs in VM Scale Set must be up-to-date with the latest scale set model. |<b> ARM API to list all the VMSS configurations under the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Compute/virtualMachineScaleSets<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br>properties/upgradePolicy/mode<br><br><b> ARM API to get all the VM instances for the specified VMSS: </b> <br> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers<br>/Microsoft.Compute/virtualMachineScaleSets/{resourceName}/virtualMachines<br>?api-version=2019-07-01 <br><br><b>Properties:</b><br> instance/properties/latestModelApplied| <b>Passed: </b><br>VMSS upgrade policy is not manual <br>or VMSS upgrade policy is manual but all the VM <br>instances are running on latest VM Scale Set model.<br><br><b>Failed: </b><br>VMSS upgrade policy is manual and any of the VM <br>instance is not running on latest VM Scale Set model. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_SI_Missing_OS_Patches<br><br><b>DisplayName:</b><br>System updates on virtual machine scale sets must be installed.<br><br><b>Description: </b><br> Virtual Machine Scale Set must have all the required OS patches installed. |<b> ARM API to fetch all the security assessment for the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/assessments<br>?api-version=2020-01-01 <br><br><b>Properties:</b><br>id, name, resourceDetails/Id, displayName, status/code, status, additionalData| <b>Passed: </b><br>ASC assessment found with Healthy status code.<br><br><b>Failed: </b><br>ASC assessment found with Unhealthy status code. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_SI_Remediate_Security_Vulnerabilities<br><br><b>DisplayName:</b><br>Vulnerabilities in security configuration on your virtual machine scale sets must be remediated.<br><br><b>Description: </b><br> Vulnerabilities in security configuration on your virtual machine scale sets must be remediated. |<b> ARM API to fetch all the security assessment for the specified subscription: </b> <br> /subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/assessments<br>?api-version=2020-01-01 <br><br><b>Properties:</b><br>id, name, resourceDetails/Id, displayName, status/code, status, additionalData| <b>Passed: </b><br>ASC assessment found with Healthy status code.<br><br><b>Failed: </b><br>ASC assessment found with Unhealthy status code. |
| <b>ControlId:</b><br>Azure_VirtualMachineScaleSet_DP_Enable_Disk_Encryption<br><b>DisplayName:</b><br>Disk encryption should be applied on virtual machine scale sets<br><b>Description: </b><br> Disk encryption must be enabled on both OS and data disks for Windows Virtual Machine Scale Set |<b> ARM API to get configuration of a Virtual Machine Scale Set: </b> <br> /subscriptions/{subscriptionId}<br>/providers/Microsoft.Compute<br>/virtualMachineScaleSets<br>?api-version=2019-07-01<br><b>Properties:</b><br> properties.virtualMachineProfile<br>.extensionProfile.extensions[\*].type<br>properties.virtualMachineProfile<br>.extensionProfile.extensions.[\*].provisioningState <br><br><b>ARM API to get instance view of Virtual Machines <br>in a Virtual Machine Scale Set</b> <br> /subscriptions/{subscriptionId}<br>/resourceGroups/{resourceGroupName}<br>/providers/Microsoft.Compute<br>/virtualMachineScaleSets/{vmScaleSetName}<br>/virtualmachines/{instanceId}/instanceView<br>?api-version=2021-03-01 <br><b>Properties</b><br> disks.statuses[\*].code | <b>Passed: </b><br>Azure disk encryption extension is installed <br>and existing disks (OS and Data) are encrypted.<br><b>Failed: </b><br>Azure disk encryption extension is not installed<br>One or more existing disks (OS or Data) are in a non-compliant state <br>(Any other state other than Encrypted is a non-compliant state. <br>Possible states: Encrypted/NotEncrypted/NotMounted/DecryptionInProgress<br>/EncryptionInProgress/VMRestartPending/Unknown/NoDiskFound) <br><b>Verify: </b><br>Storage profile for VM Scale Set unavailable or number of <br>Virtual Machine instances in VM Scale Set exceeded scan limit. |

