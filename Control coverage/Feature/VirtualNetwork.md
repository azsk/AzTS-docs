## Virtual Network

| ControlId | Dependent Azure API(s) and Properties | Control spec-let |
|-----------|-------------------------------------|------------------|
| <b>ControlId:</b><br>Azure_ERvNet_NetSec_Dont_Add_UDRs_on_Subnets<br><b>DisplayName:</b><br>There must not be a UDR on *any* subnet in an ExpressRoute-connected VNet.<br><b>Description: </b><br> There must not be a UDR on *any* subnet in an ExpressRoute-connected VNet.| <br><b>ARM API to list Virtual Networks and route table associated with each subnet of VNet at subscription level: </b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworks?<br>api-version=2019-11-01 <br><b>Properties:</b><br> properties.subnets[\*].properties.routeTable.id <br><br><b>ARM API to list Virtual Network Gateways at subscription level: </b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworkGateways?<br>api-version=2019-04-01 <br><b>Properties:</b><br>properties.gatewayType <br><br><b> ARM API to list all Route Tables at subscription level: </b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/routeTables?api-version=2020-03-01 <br><b>Properties:</b><br> properties.routes[\*].name <br> properties.routes[\*].properties.addressPrefix <br> properties.routes[\*].properties.nextHopType| <b>Passed: </b><br>1. No UDRs found on any Subnet of ERvNet. <br> 2. Only exempted UDR(s) are defined in subnet of ERvNet.<br><b>Failed: </b><br> UDRs are attached to one or more subnets in ERvNet. <br><b>NotApplicable: </b><br>Current VNet resource object is not connected to ExpressRoute gateway. |
| <b>ControlId:</b><br>Azure_ERvNet_NetSec_Dont_Use_VNet_Peerings<br><b>DisplayName:</b><br>Peering must not be allowed on ExpressRoute connected Virtual Network. <br><b>Description: </b><br> There must not be any virtual network peering on an ExpressRoute-connected VNet.| <b> ARM API to list Virtual Networks and their peering at subscription level: </b> /subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworks? <br> api-version=2019-11-01 <br><b>Properties:</b><br> properties.virtualNetworkPeerings[\*].id <br> properties.virtualNetworkPeerings[\*].properties.remoteVirtualNetwork.id <br> <br> <b> ARM API to list Virtual Network Gateways at subscription level: </b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworkGateways?<br>api-version=2019-04-01 <br><b>Properties:</b><br> properties.gatewayType | <b>Passed: </b><br>No peering found on ERvNet. <br> Only exempted peering are defined in ERvNet.<br><b>Failed: </b><br>One or more non exempted peering found on ERvNet. <br><b>NotApplicable: </b><br> Current VNet resource object is not connected to ExpressRoute gateway. |
| <b>ControlId:</b><br>Azure_ERvNet_NetSec_Dont_Add_VPN_Gateways<br><b>DisplayName:</b><br> There must not be another virtual network gateway (GatewayType = Vpn) in an ExpressRoute-connected VNet. <br><b>Description: </b><br> There must not be another virtual network gateway (GatewayType = Vpn) in an ExpressRoute-connected VNet.| <b> ARM API to list Virtual Networks and their subnets at subscription level: </b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworks? <br>api-version=2019-11-01 <br><b>Properties:</b><br> properties.subnets[\*].id <br><br> <b> ARM API to list Virtual Network Gateways at subscription level: </b> /subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworkGateways?</br> api-version=2019-04-01 <br><b>Properties:</b><br> properties.gatewayType | <b>Passed: </b><br>No other types of gateways found on the VNet other than ExpressRoute.<br><b>Failed: </b><br>Gateways of type other than ExpressRoute are found on the VNet.<br><b>NotApplicable: </b><br>Current VNet resource object is not connected to ExpressRoute gateway. |
| <b>ControlId:</b><br>Azure_ERvNet_NetSec_Dont_Enable_IPForwarding_for_NICs<br><b>DisplayName:</b><br>Set 'EnableIPForwarding' flag to false for NICs in the ExpressRoute-connected vNet. <br><b>Description: </b><br> Set 'EnableIPForwarding' flag to false for NICs in the ExpressRoute-connected vNet.| <b>ARM API to list Network Interfaces at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkInterfaces<br>?api-version=2019-04-01<br><b>Properties:</b><br>properties.ipConfigurations[\*].properties.subnet.id,<br> properties.enableIPForwarding <br> <br> <b> ARM API to list Virtual Network Gateways at subscription level: </b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworkGateways?<br>api-version=2019-04-01 <br><b>Properties:</b><br> properties.gatewayType | <b>Passed: </b><br>No NICs found on the ERvNet. <br>Or, no NICs found with EnableIPForwarding turned on the ERvNet.<br><b>Failed: </b><br>IP Forwarding is enabled for one or more NIC(s) in ERvNet.<br><b>NotApplicable: </b><br> Current VNet resource object is not connected to ExpressRoute gateway. |
| <b>ControlId:</b><br>Azure_ERvNet_NetSec_Dont_Use_Multi_NIC_VMs<br><b>DisplayName:</b><br>There must not be multiple NICs on ExpressRoute-connected VMs. <br><b>Description: </b><br> There must not be multiple NICs on ExpressRoute-connected VMs.| <b>ARM API to list Network Interfaces at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkInterfaces<br>?api-version=2019-04-01<br><b>Properties:</b><br>properties.ipConfigurations[\*].properties.subnet.id,<br> properties.virtualMachine.id <br> <br> <b> ARM API to list Virtual Network Gateways at subscription level: </b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworkGateways?<br>api-version=2019-04-01 <br><b>Properties:</b><br> properties.gatewayType | <b>Passed: </b><br>No NICs found on the ERvNet. <br>Or, no VMs attached to ERvNet have multiple NICs.<br><b>Failed: </b><br>One or more VMs in the ERvNet are connected to multiple NICs.<br><b>NotApplicable: </b><br> Current VNet resource object is not connected to ExpressRoute gateway. |
| <b>ControlId:</b><br>Azure_ERvNet_NetSec_Dont_Use_PublicIPs<br><b>DisplayName:</b><br>Remove public IPs on ER connected VMs. <br><b>Description: </b><br>There must not be any Public IPs (i.e., NICs with PublicIP) on ExpressRoute-connected VMs.| <b>ARM API to list Network Interfaces at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkInterfaces<br>?api-version=2019-04-01<br><b>Properties:</b><br>properties.ipConfigurations[\*].properties.subnet.id,<br> properties.ipConfigurations[\*].properties.publicIPAddress.id <br> <br> <b> ARM API to list Virtual Network Gateways at subscription level: </b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworkGateways?<br>api-version=2019-04-01 <br><b>Properties:</b><br> properties.gatewayType | <b>Passed: </b><br>No NICs found on the ERvNet. <br>Or, no Public IP is configured for any NIC on the ERvNet.<br><b>Failed: </b><br>Public IP(s) are configured for one or more NICs attached to ERvNet.<br><b>NotApplicable: </b><br> Current VNet resource object is not connected to ExpressRoute gateway. |
| <b>ControlId:</b><br>Azure_VNet_NetSec_Configure_NSG<br><b>DisplayName:</b><br>Associate Subnets with a Network Security Group.<br><b>Description:</b><br>NSG should be used for subnets in a virtual network to permit traffic only on required inbound/outbound ports. NSGs should not have a rule to allow any-to-any traffic.| <b>ARM API to list Virtual Networks and their constituent Subnets at subscription level:</b>/subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworks?api-version=2019-11-01<br><b>Properties:</b><br> properties.subnets[\*].properties.networkSecurityGroup.id<br> | <b>Passed:</b><br> All Subnets in the VNet have an associated NSG configured.<br> <b>Failed: </b><br>Subnets without associated NSG are found on the VNet.<br><b>NotApplicable:</b><br>Virtual Network is connected to an ExpressRoute gateway. |
| <b>ControlId:</b><br>Azure_VNet_NetSec_Justify_Peering<br><b>DisplayName:</b><br>Assure virtual network peering is not allowed.<br><b>Description:</b><br>Use of any virtual network peerings should be justified. | <b>ARM API to list all Virtual Networks in a Subscription:</b><br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/<br>virtualNetworks?api-version=2019-11-01<br><b>Properties:</b><br>properties.virtualNetworkPeerings | <b>Passed:</b><br>No peerings found on vNet.<br><b>Failed:</b><br>One or more peerings found on vNet.<br><b>NotApplicable:</b><br>Current vNet resource object is connected to ExpressRoute gateway. |
| <b>ControlId:</b><br>Azure_ERvNet_SI_Dont_Remove_Resource_Lock<br><b>DisplayName:</b><br>Ensure that the ERNetwork resource group is protected with a resource lock.<br><b>Description:</b><br>Ensure that the ERNetwork resource group is protected with a resource lock. | <b>ARM API to list all Virtual Networks in a Subscription:</b><br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/<br>virtualNetworks?api-version=2019-11-01<br><b>Properties: </b><br>properties.id<br><b>ARM API to list all Locks in a Subscription:</b><br> /subscriptions/{subscriptionId}/providers/Microsoft.Authorization/<br>locks?api-version=2015-01-01<br><b>Properties:</b><br>properties.id | <b>Passed:</b><br>Required Lock is added at RG scope.<br><b>Failed:</b><br>Required Lock is not added at RG scope.<br><b>NotApplicable:</b><br>Current VNet resource object is not connected to ExpressRoute gateway. |
| <b>ControlId:</b><br>Azure_ERvNet_SI_Add_Only_Network_Resources<br><b>DisplayName:</b><br>Add only Microsoft.Network/* resources to the ERNetwork resource group.<br><b>Description:</b><br>Add only Microsoft.Network/* resources to the ERNetwork resource group. | <b>ARM API to list all Virtual Networks in a Subscription:</b><br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/<br>virtualNetworks?api-version=2019-11-01<br><b>Properties: </b><br>properties.id | <b>Passed:</b><br>No other resource type (except "Microsoft.Network/\*") found in RG.<br><b>Failed:</b><br>Other resource types (except "Microsoft.Network/\*") present in RG.<br><b>NotApplicable:</b><br>Current VNet resource object is not connected to ExpressRoute gateway. |<br>
| <b>ControlId:</b><br>Azure_ERvNet_NetSec_Revoke_PublicIPs_On_Sub<br><b>DisplayName:</b><br>There must not be any Public IPs on Subscription with ExpressRoute connection.<br><b>Description:</b><br>There must not be any Public IPs on Subscription with ExpressRoute connection. | <b>ARM API to list all Public IP addresses in a Subscription:</b><br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/<br>publicIPAddresses?api-version=2019-11-01<br><b>Properties:</b><br>Total Public IP addresses.<br> | <b>Passed:</b><br>No Public IPs found on subscription.<br><b>Failed:</b><br>One or more Public IP(s) found on subscription.<br><b>NotApplicable:</b><br>Current VNet resource object is not connected to ExpressRoute gateway. |
| <b>ControlId:</b><br>Azure_VNet_NetSec_Justify_PublicIPs<br><b>DisplayName:</b><br>Minimize the number of Public IPs (i.e. NICs with PublicIP) on a virtual network.<br><b>Description:</b><br>There must not be any Public IPs (i.e. NICs with PublicIP) on a virtual network. | <b>ARM API to list Network Interfaces at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkInterfaces<br>?api-version=2019-04-01<br><b>Properties:</b><br>properties.ipConfigurations[\*].properties.subnet.id,<br> properties.ipConfigurations[\*].properties.publicIPAddress.id <br> <br> <b> ARM API to list Virtual Network Gateways at subscription level: </b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworkGateways?<br>api-version=2019-04-01 <br><b>Properties:</b><br> properties.gatewayType | <b>Passed: </b><br>No NICs found on the vNet. <br>Or, no Public IP is configured for any NIC on the vNet.<br><b>Failed: </b><br>Public IP(s) are configured for one or more NICs attached to vNet.<br><b>NotApplicable: </b><br>Control is not applicable for ERvNets.<br>|
|<b>ControlId:</b><br>Azure_VNet_NetSec_Justify_Gateways<br><b>DisplayName:</b><br> Presence of any virtual network gateways (GatewayType = VPN/ExpressRoute) in the virtual network must be justified <br><b>Description: </b><br> There must not be any VPN gateway in the virtual network.| <b> ARM API to list Virtual Networks and their subnets at subscription level: </b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworks? <br>api-version=2019-11-01 <br><b>Properties:</b><br> properties.subnets[\*].id <br><br> <b> ARM API to list Virtual Network Gateways at subscription level: </b> /subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworkGateways?</br> api-version=2019-04-01 <br><b>Properties:</b><br> properties.gatewayType | <b>Passed: </b><br>No Virtual Network Gateways found in VNet.<br><b>Failed: </b><br>Gateways of type other than ExpressRoute are found on the VNet.<br><b>NotApplicable: </b><br>Current vNet resource object is connected to ExpressRoute gateway. |
| <b>ControlId:</b><br>Azure_VNet_NetSec_Justify_IPForwarding_for_NICs<br><b>DisplayName:</b><br>Use of IP Forwarding on any NIC in a virtual network should be scrutinized. <br><b>Description: </b><br> The 'EnableIPForwarding' flag must not be set to true for NICs in the vNet.| <b>ARM API to list Network Interfaces at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkInterfaces<br>?api-version=2019-04-01<br><b>Properties:</b><br>properties.ipConfigurations[\*].properties.subnet.id,<br> properties.enableIPForwarding <br> <br> <b> ARM API to list Virtual Network Gateways at subscription level: </b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworkGateways?<br>api-version=2019-04-01 <br><b>Properties:</b><br> properties.gatewayType | <b>Passed: </b><br>No NICs found on the vNet. <br>Or, no NICs found with EnableIPForwarding turned on the vNet.<br><b>Failed: </b><br>IP Forwarding is enabled for one or more NIC(s) in vNet.<br><b>NotApplicable: </b><br> Current vNet resource object is connected to ExpressRoute gateway. |
