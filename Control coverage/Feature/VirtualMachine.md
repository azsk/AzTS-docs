## Virtual Machine

| ControlId | Dependent Azure API(s) and Properties | Control spec |
|-----------|---------------------------------------|------------------|
| <b>ControlId:</b><br>Azure_VirtualMachine_SI_Enable_Vuln_Solution<br><b>DisplayName:</b><br>Install DSRE Qualys Cloud Agent on assets.<br><b>Description:</b><br>Vulnerability assessment solution should be installed on VM. | <b>ARM API to list Virtual Machine Extensions at <br>resource level:</b><br>/subscriptions/{subscriptionId}/resourceGroups/<br>{resourceGroupName}/providers/Microsoft.<br>Compute/virtualMachines/{vmName}<br>/extensions?api-version=2019-07-01<br><b>Properties:</b><br>publisher, type<br>| <b>Passed: </b><br>Required vulnerability assessment solution is present in VM.<br><b>Failed: </b><br>Required vulnerability assessment solution is not present in VM.<br><b>NotApplicable: </b><br>VM instance is part of AKS or ADB cluster.<br><b>Not Scanned: </b><br>VM OS type is null or empty. |
| <b>ControlId:</b><br>Azure_VirtualMachine_SI_Enable_Monitoring_Agent<br><b>DisplayName:</b><br>All VMs must have Monitoring Agent enabled.<br><b>Description:</b><br>All VMs must have Monitoring Agent enabled. | <b>ARM API to list Virtual Machine Extensions at <br>resource level:</b><br>/subscriptions/{subscriptionId}/resourceGroups/<br>{resourceGroupName}/providers/Microsoft.<br>Compute/virtualMachines/{vmName}<br>/extensions?api-version=2019-07-01<br><b>Properties:</b><br>publisher, type| <b>Passed: </b><br>All required extensions are present in VM<br><b>Failed: </b><br>One or more required extensions are missing in VM.<br><b>NotApplicable: </b><br>VM is part of ADB cluster.<br><b>Not Scanned: </b><br>VM OS type is null or empty. |
| <b>ControlId:</b><br>Azure_VirtualMachine_NetSec_Apply_ASC_Network_<br>Recommendations<br><b>DisplayName:</b><br>Apply Adaptive Network Hardening to your virtual machines.<br><b>Description:</b><br>Adaptive Network Hardening recommendations <br>should be applied on internet facing virtual machines. | <b>ARM API to list security assessments at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/assessments?<br>api-version=2020-01-01<br><b>Properties:</b><br>id, name, resourceDetails/Id, displayName, status/code, status, additionalData | <b>Passed: </b><br>ASC assessment found with Healthy status code.<br><b>Failed: </b><br>ASC assessment found with Unhealthy status code.|
| <b>ControlId:</b><br>Azure_VirtualMachine_Config_Enable_NSG<br><b>DisplayName:</b><br>Secure internet-facing virtual machines.<br><b>Description:</b><br>NSG must be configured for Virtual Machine. | <b>ARM API to list Network Interfaces at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkInterfaces<br>?api-version=2019-04-01<br><b>Property:</b><br>publicIPAddress/id, networkSecurityGroup/id<br><br><b>ARM API to list Virtual Networks at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/virtualNetworks<br>?api-version=2019-11-01<br><b>Property:</b><br>networkSecurityGroup/id<br>| <b>Passed: </b><br>NSG is configured for the VM or VM does not have any public IP configured.<br><b>Failed: </b><br>No NSG found on the VM.<br><b>NotApplicable: </b><br>VM instance is part of ADB cluster.|
| <b>ControlId:</b><br>Azure_VirtualMachine_NetSec_Dont_Open_Restricted_<br>Ports<br><b>DisplayName:</b><br>Secure internet-facing virtual machines.<br><b>Description:</b><br>Do not leave restricted ports open on Virtual Machines. | <b>ARM API to list Network Interfaces at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkInterfaces<br>?api-version=2019-04-01<br><b>Property:</b><br>networkSecurityGroup/id<br><br><b>ARM API to list Virtual Networks at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/virtualNetworks<br>?api-version=2019-11-01<br><b>Property:</b><br>networkSecurityGroup/id<br><br><b>ARM API to list Network Security Groups at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkSecurityGroups<br>?api-version=2019-04-01<br><b>Property:</b><br>destinationPortRange<br><br><b>ARM API to list JIT network access policies at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/jitNetworkAccessPolicies<br>?api-version=2020-01-01<br><b>Property:</b><br>virtualMachines/ports| <b>Passed: </b><br>NSG is configured and no inbound port is open or NSG is configured and no restricted ports are open<br><b>Failed: </b><br>No NSG is configured on VM or NSG is configured but restricted ports are open.<br><b>NotApplicable: </b><br>VM instance is part of ADB cluster.|
| <b>ControlId:</b><br>Azure_VirtualMachine_DP_Enable_Disk_Encryption<br><b>DisplayName:</b><br>Disk encryption should be applied on virtual machines.<br><b>Description:</b><br>Disk encryption must be enabled on both OS and <br> data disks for Windows Virtual Machine. | <b>ARM API to list security assessments at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/assessments?<br>api-version=2020-01-01<br><b>Properties:</b><br>id, name, resourceDetails.Id, displayName, status.code, status, additionalData <br><br> <b>ARM API to list Virtual Machines at subscription level:</b><br>/subscriptions/{0}/providers/Microsoft.Compute/virtualMachines?api-version=2019-07-01<br><b>Properties:</b><br>properties.storageProfile.osDisk.caching, properties.storageProfile.diffDiskSettings.option | <b>Passed: </b><br>ASC assessment found with Healthy status code.<br><b>Failed: </b><br>ASC assessment found with Unhealthy status code.<br><b>NotApplicable: </b><br>VM is part of Azure Databricks cluster or using ephemeral OS disks.|
| <b>ControlId:</b><br>Azure_VirtualMachine_Just_In_Time_Network_Access_Control<br><b>DisplayName:</b><br>Just-In-Time network access control must be applied on virtual machines.<br><b>Description:</b><br>Possible network Just In Time (JIT) access will be monitored by Azure Security Center as recommendations. | <b>ARM API to list security assessments at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/assessments?<br>api-version=2020-01-01<br><b>Properties:</b><br>id, name, resourceDetails.Id, displayName, status.code, status, additionalData | <b>Passed: </b><br>ASC assessment found with Healthy status code.<br><b>Failed: </b><br>ASC assessment found with Unhealthy status code.<br><b>NotApplicable: </b><br>VM is part of either Azure Databricks cluster or Azure Kubernetes service cluster.|
| <b>ControlId:</b><br>Azure_VirtualMachine_NetSec_Justify_PublicIPs<br><b>DisplayName:</b><br>Public IPs on a Virtual Machine should be carefully reviewed.<br><b>Description:</b><br>Public IPs on a Virtual Machine should be carefully reviewed. |<b>ARM API to list Virtual Machines at subscription level:</b><br>/subscriptions/{0}/providers/Microsoft.Compute/virtualMachines?api-version=2019-07-01<br><b>Properties:</b><br>properties.networkProfile.networkInterfaces[\*].id <br><br> <b>ARM API to list Network Interfaces at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkInterfaces<br>?api-version=2019-04-01<br><b>Properties:</b><br> publicIPAddress.id  | <b>Passed: </b><br>No Public IP address is associated with VM.<br><b>Verify: </b><br>One or more Public IP address is associated with VM.<br><b>NotApplicable: </b><br>VM is part of Azure Databricks cluster.|
| <b>ControlId:</b><br>Azure_VirtualMachine_SI_Deploy_Data_Collection_Extension<br><b>DisplayName:</b><br>[Preview]: Install Network data collection agents.<br><b>Description:</b><br>Network traffic data collection agent should be installed on Windows/Linux virtual machines. | <b> ARM API to list Virtual Machine Extensions at resource level: </b> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachines/{vmName}/extensions? <br> api-version=2019-07-01 <br><b>Properties:</b><br> properties.type, properties.publisher <br><br><b>ARM API to list security assessments at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Security/assessments?<br>api-version=2020-01-01<br><b>Properties:</b><br>id, name, resourceDetails.Id, displayName, status.code, status, additionalData| <b>Passed: </b><br>Network traffic data collection agent is present in VM.<br><b>Failed: </b><br>Network traffic data collection agent is missing for VM.<br><b>NotApplicable: </b><br>VM is part of Azure Databricks cluster.|
| <b>ControlId:</b><br>Azure_VirtualMachine_NetSec_Open_Allowed_Ports_Only<br><b>DisplayName:</b><br>Only allowed ports must be opened on Virtual Machines.<br><b>Description:</b><br>Only allowed ports must be opened on Virtual Machines. |<b>ARM API to list Virtual Machines at subscription level:</b><br>/subscriptions/{0}/providers/Microsoft.Compute/virtualMachines?api-version=2019-07-01<br><b>Properties:</b><br>properties.networkProfile.networkInterfaces[\*].id <br><br> <b>ARM API to list Network Interfaces at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkInterfaces<br>?api-version=2019-04-01<br><b>Properties:</b><br> networkSecurityGroup.id<br><br><b>ARM API to list Virtual Networks (and associated subnets) at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/virtualNetworks<br>?api-version=2019-11-01<br><b>Properties:</b><br>properties.subnets[\*].networkSecurityGroup.id<br><br><b>ARM API to list Network Security Groups at <br>subscription level:</b><br>/subscriptions/{subscriptionId}/providers<br>/Microsoft.Network/networkSecurityGroups<br>?api-version=2019-04-01<br><b>Properties:</b><br>destinationPortRange, destinationPortRanges<br>| <b>Passed: </b><br>NSG is configured and no inbound port is open or NSG is configured and only allowed ports are open.<br><b>Failed: </b><br>No NSG is configured on VM or NSG is configured but other than allowed ports are open.<br><b>NotApplicable: </b><br>VM instance is part of Azure Databricks cluster or connected to ERvNET.|
| <b>ControlId:</b><br>Azure_VirtualMachine_Audit_Enable_Diagnostics<br><b>DisplayName:</b><br>Diagnostics must be enabled on the Virtual Machine.<br><b>Description:</b><br>Diagnostics (IaaSDiagnostics extension on Windows; LinuxDiagnostic extension on Linux) must be enabled on Virtual Machine. | <b>ARM API to list all extensions in a Virtual Machine:</b><br>/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupId}/<br>providers/Microsoft.Compute/virtualMachines/{virtualMachineName}/<br>extensions?api-version=2019-07-01<br><b>Properties:</b><br>properties.type, properties.publisher | <b>Passed:</b><br>- All required diagnostics extension(s) are configured.<br>- No mandatory diagnostics extension(s) have been specified for the Operating System.<br><b>Failed:</b><br>- One or more diagnostics extension(s) are not configured on the Virtual Machine. |
| <b>ControlId:</b><br>Azure_VirtualMachine_SI_ASC_Recommendations<br><b>DisplayName:</b><br>Virtual Machine must implement all the flagged ASC recommendations.<br><b>Description:</b><br>Virtual Machine must implement all the flagged ASC recommendations. | <b>ARM API to list all security assessments in a Subscription:</b><br> /subscriptions/{subscriptionId}/<br>providers/Microsoft.Security/assessments?api-version=2020-01-01<br><b>Properties:</b><br>id, name, properties.resourceDetails.id, <br>properties.displayName, properties.status, properties.additionalData<br><b>Assessments:</b><br>- d57a4221-a804-52ca-3dea-768284f06bb7 - Disk encryption should<br> be applied on virtual machines.<br>- 35f45c95-27cf-4e52-891f-8390d1de5828 - Adaptive application<br> controls for defining safe applications should be enabled on your<br> machines.<br>- ffff0522-1e88-47fc-8382-2a80ba848f5d - A vulnerability assessment<br> solution should be enabled on your virtual machines. | <b>Passed:</b><br>No Azure Security Center Assessment for the Virtual Machine is "Unhealthy".<br><b>Failed:</b><br>One or more Azure Security Center Assessments for the Virtual Machine are "Unhealthy". |
| <b>ControlId:</b><br>Azure_VirtualMachine_SI_ASC_OS_Vulnerabilities<br><b>DisplayName:</b><br>Virtual Machine must be in a healthy state in Azure Security Center.<br><b>Description:</b><br>Virtual Machine must be in a healthy state in Azure Security Center. | <b>ARM API to list all security assessments in a Subscription:</b> <br> /subscriptions/{subscriptionId}/<br>providers/Microsoft.Security/assessments?api-version=2020-01-01<br><b>Properties:</b><br>id, name, properties.resourceDetails.id, <br>properties.displayName, properties.status, properties.additionalData<br><b>Assessments:</b><br>- 181ac480-f7c4-544b-9865-11b8ffe87f47 - Vulnerabilities in security<br>configuration on your machines should be remediated. | <b>Passed:</b><br>Azure Security Center (ASC) Assessment status is in the approved status(es) list.<br><b>Failed:</b><br>Azure Security Center (ASC) Assessment status is not in the approved status(es) list. |
| <b>ControlId:</b><br>Azure_VirtualMachine_NetSec_Apply_ASC_Network_Recommendations<br><b>DisplayName:</b><br>Adaptive Network Hardening uses a machine learning algorithm that factors in actual traffic, known trusted configuration, threat intelligence, and other indicators of compromise, and then provides recommendations to further restrict NSGs rules for an improved security posture.<br><b>Description:</b><br>Adaptive Network Hardening uses a machine learning algorithm that factors in actual traffic, known trusted configuration, threat intelligence, and other indicators of compromise, and then provides recommendations to further restrict NSGs rules for an improved security posture. | <b>ARM API to list all security assessments in a Subscription:</b> <br> /subscriptions/{subscriptionId}/<br>providers/Microsoft.Security/assessments?api-version=2020-01-01<br><b>Properties:</b><br>id, name, properties.resourceDetails.id, <br>properties.displayName, properties.status, properties.additionalData<br><b>Assessments:</b><br>- f9f0eed0-f143-47bf-b856-671ea2eeed62 - Adaptive network hardening<br> recommendations should be applied on internet facing virtual machines. | <b>Passed:</b><br>Azure Security Center (ASC) Assessment status is "Healthy".<br><b>Failed:</b><br>Azure Security Center (ASC) Assessment status is "Unhealthy". |
| <b>ControlId:</b><br>Azure_VirtualMachine_SI_Deploy_GuestConfig_Extension<br><b>DisplayName:</b><br>Guest Configuration extension must be deployed to the VM using Azure Policy assignment. <br><b>Description: </b><br> Guest Configuration extension must be deployed to the VM using Azure Policy assignment. | <b> ARM API to list Virtual Machines at subscription level:</b> <br> /subscriptions/{subscriptionId}/providers/Microsoft.Compute<br> /virtualMachines?api-version=2019-07-01<br><b>Properties:</b><br> identity.type <br> <br> <b> ARM API to list Virtual Machine Extensions at resource level: </b> /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}<br>/providers/Microsoft.Compute/virtualMachines/{vmName}/extensions? <br> api-version=2019-07-01 <br><b>Properties:</b><br> properties.type <br> properties.publisher | <b>Passed: </b><br> Guest config extension is present, and <br> System assigned MI is enabled for VM.<br><b>Failed: </b><br> Guest config extension is not present in VM, or <br> System assigned MI is disabled for VM.<br><b>NotApplicable: </b><br>VM is part of ADB cluster and AKS VMs. |
| <b>ControlId:</b> <br>Azure_VirtualMachine_SI_Remediate_Assessment_Soln_Vulnerabilities <br> <b>DisplayName: </b> <br>Vulnerabilities must be remediated by a Vulnerability Assessment solution. <br><b>Description: </b><br> Vulnerabilities must be remediated by a Vulnerability Assessment solution. | <b>ARM API to list security assessments at subscription<br> level:</b><br>/subscriptions/{subscriptionId}/providers/Microsoft.Security<br>/assessments?api-version=2020-01-01<br><b>Properties:</b><br>id, name, resourceDetails.Id, displayName, status.code,<br> status, additionalData | <b>Scope: </b> Applies to all Virtual Machine resources.<br><br><b>Config: </b> AssessmentName: 71992a2a-d168-42e0-b10e-6b45fa2ecddb <br><br> <b>Passed: </b><br>ASC assessment found with Healthy status code.<br><br> <b>Failed: </b><br>ASC assessment found with Unhealthy status code. |
| <b>ControlId:</b><br>Azure_VirtualMachine_SI_Remediate_Container_Security_Vulnerabilities<br><b>DisplayName:</b><br>Vulnerabilities in container security configurations must be remediated. <br><b>Description: </b><br> Vulnerabilities in container security configurations should be remediated. | <b> ARM API to list security assessments at subscription<br> level:</b><br>/subscriptions/{subscriptionId}/providers/Microsoft.Security<br>/assessments?api-version=2020-01-01<br><b>Properties:</b><br>id, name, resourceDetails.Id, displayName, status.code,<br> status, additionalData | <b>Scope: </b> Applies to all Virtual Machine resources.<br><br><b>Config: </b> AssessmentName: 0677209d-e675-2c6f-e91a-54cef2878663 <br><br> <b>Passed: </b><br>ASC assessment found with Healthy status code.<br><br> <b>Failed: </b><br>ASC assessment found with Unhealthy status code. |
| <b>ControlId:</b><br>Azure_VirtualMachine_SI_Remediate_Security_Vulnerabilities<br><b>DisplayName:</b><br>Vulnerabilities in security configuration on your machines must be remediated. <br><b>Description: </b><br> Vulnerabilities in security configuration on your machines should be remediated. | <b>ARM API to list security assessments at subscription<br> level:</b><br>/subscriptions/{subscriptionId}/providers/Microsoft.Security<br>/assessments?api-version=2020-01-01<br><b>Properties:</b><br>id, name, resourceDetails.Id, displayName, status.code,<br> status, additionalData | <b>Scope: </b> Applies to all Virtual Machine resources.<br><br><b>Config: </b> AssessmentName: 181ac480-f7c4-544b-9865-11b8ffe87f47 <br><br> <b>Passed: </b><br>ASC assessment found with Healthy status code.<br><br> <b>Failed: </b><br>ASC assessment found with Unhealthy status code. |


