<##########################################
Overview:
  This file contains functions to help remediate antimalware issues

ControlId: 
  Azure_VirtualMachine_SI_Enable_Antimalware

DisplayName:
  Remediate Azure VM Antimalware issues.

Pre-requisites:
  1. Authenticated to Azure
  2. At least Contributor role on VM

Steps to use:
  1. Download this file
  2. At a Powershell prompt or in your script file, dot-source this file: ```. ./Azure_VirtualMachine_SI_Enable_Antimalware.ps1```
  3. Call the functions with arguments

Examples:
  GetRealtimeMonitoringDisabled
########################################
#>

function GetRealtimeMonitoringDisabled() {
  <#
    .SYNOPSIS
    This command returns whether Realtime Monitoring is Disabled.
    .DESCRIPTION
    This command returns whether Realtime Monitoring is Disabled. If Realtime monitoring is ENABLED, we want this to return False.
  #>

  [CmdletBinding()]
  param()

  Get-MpPreference | Select-Object DisableRealtimeMonitoring, MeteredConnectionUpdates, Proxy*, Signature*
}

function GetComputerStatus() {
  <#
    .SYNOPSIS
    This command returns various MDE status properties.
    .DESCRIPTION
    This command returns various MDE status properties.
  #>

  [CmdletBinding()]
  param()

  Get-MpComputerStatus | Select-Object AntispywareEnabled, AntispywareSignatureAge, AntispywareSignatureLastUpdated, AntispywareSignatureVersion, AntivirusEnabled, AntivirusSignatureAge, AntivirusSignatureLastUpdated, AntivirusSignatureVersion, BehaviorMonitorEnabled, DefenderSignaturesOutOfDate, DeviceControlPoliciesLastUpdated, FullScanOverdue, NISEnabled, NISEngineVersion, NISSignatureAge, NISSignatureLastUpdated, NISSignatureVersion, OnAccessProtectionEnabled, QuickScanAge, QuickScanOverdue, QuickScanSignatureVersion, RealTimeProtectionEnabled, RebootRequired
}

function ScheduleHourlySignatureUpdates() {
  <#
    .SYNOPSIS
    This command creates a Windows scheduled task that runs hourly to update MDE signatures.
    .DESCRIPTION
    This command creates a Windows scheduled task that runs hourly to update MDE signatures. MUST BE RUN IN ELEVATED CONTEXT!
  #>

  [CmdletBinding()]
  param()

  # This assumes you have Powershell 7.x+ installed
  $action = New-ScheduledTaskAction -Execute "pwsh.exe" -Argument "-Command Update-MpSignature"
  # This is if you only have Windows Powershell 5.1 installed
  #$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-Command Update-MpSignature"

  $hourly = (New-TimeSpan -Hours 1)
  $days = (New-TimeSpan -Days 365)
  $trigger = New-ScheduledTaskTrigger -Once -At 12am -RepetitionInterval $hourly -RepetitionDuration $days

  $principal = New-ScheduledTaskPrincipal -GroupId "BUILTIN\Administrators"

  Register-ScheduledTask -Action $action -Trigger $trigger -TaskName "Update MDE Signatures Hourly" -Principal $principal
}